# OneLink Sovereign Vault - Instructional Context

This file provides the necessary context for Gemini to understand and assist with the OneLink Sovereign Vault codebase (v2.5).

## 1. Project Overview
OneLink is a **privacy-first, zero-knowledge peer-to-peer (P2P) sharing platform**. It allows creators to build a digital presence (link-in-bio) with end-to-end encryption (E2EE) and selective content sharing.

### Core Architectural Principles
- **Trust No One (TNO):** All encryption/decryption happens client-side. The backend (Firebase) never sees plaintext data.
- **Serverless Static-First:** Built as a Next.js Static Export (`output: 'export'`) deployed on Firebase Hosting.
- **Client-Side Encryption:** Uses Web Crypto API (RSA-OAEP 2048 for keys, AES-GCM 256 for content).
- **Zero-Knowledge Backend:** Firebase serves as a storage/retrieval engine for encrypted blobs.

## 2. Technology Stack
- **Framework:** Next.js 16 (App Router)
- **Backend:** Firebase (Auth, Firestore, Storage)
- **Styling:** Tailwind CSS 4
- **Animations:** Framer Motion (Glassmorphism & Bento transitions)
- **Security:** Web Crypto API
- **State Management:** React Hooks + Firebase `onSnapshot` for real-time data.

## 3. Directory Structure
- `/app`: Application routes.
    - `/auth`: Login, registration, and success pages.
    - `/dashboard`: Main authenticated area (Chat, Friends, Links, Profile).
    - `/u/profile`: Static catch-all for public profiles.
- `/components`: Atomic UI components.
    - `/dashboard`: Layout shell and navigation.
    - `/friends`: Chat, conversation list, and friend management.
    - `/links`: Bento grid link block management.
    - `/public`: Public profile rendering.
    - `/ui`: Reusable Shadcn/UI components.
- `/hooks`: Custom hooks.
    - `use-chat.ts`: Real-time E2EE chat listeners and operations.
    - `use-crypto.ts`: Core encryption primitives and lazy decryption.
    - `use-rsa-keycheck.ts`: Automated RSA key generation and sync.
- `/lib`: Utility libraries.
    - `crypto.ts`: Comprehensive E2EE library implementation.
    - `/firebase`: Client-side initialization.
- `/scripts`: SQL scripts (legacy/reference) and Firestore setup.

## 4. Key Workflows & Conventions
### P2P Key Handshake
1. Receiver requests access to an asset and provides their Public Key.
2. Owner re-encrypts the asset's AES key using the Receiver's Public Key.
3. Receiver decrypts the AES key using their Private Key to access the asset.

### Sovereign Chat v2.0
- **E2EE:** Messages are encrypted with a conversation-specific AES key.
- **Soft Delete (TTL):** Messages have an `expiresAt` field.
    - **Client:** `useChat` filters out messages where `expiresAt < now`.
    - **Server:** Firestore TTL policy handles physical deletion.
- **Typing Indicators:** Managed via a `presence` sub-collection with 5-second TTL.

### RSA Key Management
- Private keys are stored in `localStorage` (`onelink_private_key_{uid}`).
- Keys are backed up to Firestore (Vault) only if encrypted with a user passphrase (PBKDF2).
- `useRSAKeyCheck` ensures keys are generated or restored on dashboard load.

## 5. Building and Running
```bash
# Development server
npm run dev

# Production Build (Generates /out directory)
npm run build

# Deployment (Firebase)
firebase deploy --only hosting,firestore,storage
```

## 6. Critical Security Files
- `firestore.rules`: Enforces participant validation for chats and owner validation for profiles.
- `storage.rules`: Restricts downloads to owners or valid access grant holders.
- `cors.json`: Required for P2P file uploads to Firebase Storage.

## 7. Current Project Status
- **Renamed:** Connections -> Friends.
- **Renamed:** Sidebar includes Chat as a primary view.
- **Decommissioned:** All AI features and Stripe integration.
- **Pending:** Billing-disabled environment requires "Soft Delete" logic (implemented in hooks).

---
*Generated by Gemini CLI Agent*
